{% extends "base.html" %}
{% block title %}Register & Pay - KVS Kabaddi Academy{% endblock %}
{% block content %}

<link rel="icon" href="/path/to/favicon.ico" type="image/x-icon">

<div class="reg-main-container">
  <div class="registration-container">
    <h1 class="form-title">Register & Pay</h1>

    <form id="regForm" class="registration-form">
      <label>Name:<input type="text" name="name" class="form-input" required></label>
      <label>Father Name:<input type="text" name="father_name" class="form-input"></label>
      <label>DOB:<input type="date" name="dob" class="form-input"></label>
      <label>Class:<input type="text" name="class" class="form-input"></label>
      <label>Academy Join Date:<input type="date" name="academy_join" class="form-input" required></label>
      <label>Duration (e.g. 6 months, 1 year):<input type="text" name="duration" class="form-input" placeholder="e.g. 6 months" required></label>
      <label>Mobile No.:<input type="text" name="contact" class="form-input" maxlength="10" inputmode="numeric" required oninput="this.value=this.value.replace(/[^0-9]/g,'')"></label>
      <label>Aadhaar Number:<input type="text" name="aadhaar" class="form-input" maxlength="14" inputmode="numeric" required oninput="this.value=this.value.replace(/[^0-9]/g,'')"></label>
      <button type="button" id="payBtn" class="btn-primary">Pay ₹1 & Register</button>
    </form>

    <div id="msg" style="margin-top:12px;color:#555;"></div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("regForm");
  const payBtn = document.getElementById("payBtn");
  const msgEl = document.getElementById("msg");
  const setMsg = (t) => { if (msgEl) msgEl.textContent = t || ""; console.log("[UI]", t); };

  // ⚠️ Change this to your backend origin (no trailing slash)
  const API_BASE = "https://YOUR-BACKEND-ORIGIN"; // e.g. https://api.kvsacademy.org

  payBtn.addEventListener("click", startPayment);

  async function readAsJson(resp) {
    const ct = resp.headers.get("content-type") || "";
    const text = await resp.text();
    if (!ct.includes("application/json")) {
      throw new Error(`Expected JSON, got: ${text.slice(0, 200)}`);
    }
    try { return JSON.parse(text); }
    catch (e) { throw new Error(`Bad JSON: ${text.slice(0, 200)}`); }
  }

  async function startPayment () {
    try {
      const name = form.elements['name'].value.trim();
      const contact = form.elements['contact'].value.trim();
      const aadhaarRaw = form.elements['aadhaar'] ? form.elements['aadhaar'].value.replace(/\s+/g, '') : "";
      const duration = form.elements['duration'].value.trim();
      const academyJoin = form.elements['academy_join'].value.trim();

      if (!name || !contact || !aadhaarRaw || !duration || !academyJoin) { alert("Please fill in all required fields before proceeding."); return; }
      if (!/^\d{12}$/.test(aadhaarRaw)) { alert("Please enter a valid 12-digit Aadhaar number."); return; }
      if (!/^\d{10}$/.test(contact)) { alert("Please enter a valid 10-digit mobile number."); return; }

      const formData = new FormData(form);
      const data = {};
      formData.forEach((v, k) => data[k] = v);
      data.aadhaar = aadhaarRaw;

      setMsg("Creating order…");
      // ✅ Use the correct origin and the exact route name your server exposes.
      // If your server route is /create-order, change it here accordingly.
      const orderRes = await fetch(`${API_BASE}/create_order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // For ₹1 use 100 paise. Or omit this and have the server set amount=100.
        body: JSON.stringify({ amount: 100 })
      });

      if (!orderRes.ok) {
        const t = await orderRes.text();
        throw new Error(`Create order failed ${orderRes.status}: ${t.slice(0,200)}`);
      }
      const order = await readAsJson(orderRes);
      console.log("[create_order]", orderRes.status, order);

      setMsg("Opening payment popup…");
      const options = {
        key: order.key || order.key_id,   // support either field from server
        amount: order.amount,
        currency: order.currency || "INR",
        name: "KVS Kabaddi Academy",
        description: "Admission Fee",
        order_id: order.id,
        prefill: { name: data.name, contact: data.contact },
        theme: { color: "#FACC15" },
        handler: async function (response) {
          try {
            setMsg("Verifying payment…");
            // ✅ Match server route name exactly
            const verifyRes = await fetch(`${API_BASE}/verify-payment`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature
              })
            });

            if (!verifyRes.ok) {
              const t = await verifyRes.text();
              throw new Error(`Verify failed ${verifyRes.status}: ${t.slice(0,200)}`);
            }
            const verify = await readAsJson(verifyRes);
            console.log("[verify-payment]", verifyRes.status, verify);

            if (!(verify && (verify.ok === true || verify.status?.includes("verified")))) {
              alert("❌ Payment verification failed on server.");
              setMsg("Verification failed.");
              location.href = "/payment-failed";
              return;
            }

            setMsg("Saving registration…");
            const saveRes = await fetch(`${API_BASE}/registration`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ...data, payment_id: response.razorpay_payment_id })
            });

            if (!saveRes.ok) {
              const t = await saveRes.text();
              throw new Error(`Registration save failed ${saveRes.status}: ${t.slice(0,200)}`);
            }
            const saveJson = await readAsJson(saveRes);
            console.log("[registration]", saveRes.status, saveJson);

            if (saveJson && saveJson.success) {
              location.href = "/payment-success";
            } else {
              alert("Payment verified, but saving registration failed.");
              setMsg("Payment verified, but DB save failed.");
            }
          } catch (e) {
            console.error("[handler error]", e);
            alert("Verification/save error: " + e.message);
            location.href = "/payment-failed";
          }
        },
        modal: { ondismiss: function () { setMsg("Payment popup closed. No charge made."); } }
      };

      const rzp = new Razorpay(options);
      rzp.on("payment.failed", function (res) {
        console.warn("[payment.failed]", res);
        alert("Payment Failed: " + (res.error?.description || "Unknown error"));
        location.href = "/payment-failed";
      });

      rzp.open();

    } catch (err) {
      console.error("[startPayment error]", err);
      setMsg("Error: " + err.message);
      alert("Error: " + err.message);
    }
  }

  const aadhaarInput = document.querySelector("input[name='aadhaar']");
  if (aadhaarInput) {
    aadhaarInput.addEventListener("input", function(e) {
      let value = e.target.value.replace(/\s+/g, "").replace(/[^0-9]/g, "");
      if (value.length > 12) value = value.slice(0, 12);
      e.target.value = value.replace(/(\d{4})(?=\d)/g, "$1 ").trim();
    });
  }
});
</script>

{% endblock %}
