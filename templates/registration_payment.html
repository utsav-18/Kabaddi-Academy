{% extends "base.html" %}
{% block title %}Register & Pay - KVS Kabaddi Academy{% endblock %}
{% block content %}

<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

<div class="reg-main-container">
  <div class="registration-container">
    <h1 class="form-title">Register & Pay</h1>

    <!-- <div style="margin:8px 0 16px; font-weight:600;">
      Admission Fee: <span style="color:#16a34a;">₹{{ amount or fixed_amount or 199 }}</span> (fixed)
    </div> -->

    <form id="regForm" class="registration-form">
      <label>Name:<input type="text" name="name" class="form-input" required></label>
      <label>Father Name:<input type="text" name="father_name" class="form-input"></label>
      <label>DOB:<input type="date" name="dob" class="form-input"></label>
      <label>Class:<input type="text" name="class" class="form-input"></label>
      <label>Academy Join Date:<input type="date" name="academy_join" class="form-input" required></label>
      <label>Duration (e.g. 6 months, 1 year):<input type="text" name="duration" class="form-input" placeholder="e.g. 6 months" required></label>

      <!-- NEW: Kit Size dropdown -->
      <label>Kit Size:
        <select name="kit_size" class="form-input" required>
          <option value="">Select</option>
          <option value="XS">XS</option>
          <option value="S">S</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="XL">XL</option>
          <option value="XXL">XXL</option>
        </select>
      </label>

      <!-- NEW: Shoe Size integer only -->
      <label>Shoe Size:
        <input type="text" name="shoe_size" class="form-input" required
               inputmode="numeric" pattern="^[0-9]+$"
               oninput="this.value=this.value.replace(/[^0-9]/g,'')"
               placeholder="e.g. 8">
      </label>

      <label>Mobile No.:<input type="text" name="contact" class="form-input" maxlength="10" inputmode="numeric" required oninput="this.value=this.value.replace(/[^0-9]/g,'')"></label>
      <label>Aadhaar Number:<input type="text" name="aadhaar" class="form-input" maxlength="14" inputmode="numeric" required oninput="this.value=this.value.replace(/[^0-9]/g,'')"></label>

      <button type="button" id="payBtn" class="btn-primary">Pay ₹{{ amount or fixed_amount or 199 }} & Register</button>
    </form>

    <div id="msg" style="margin-top:12px;color:#555;"></div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("regForm");
  const payBtn = document.getElementById("payBtn");
  const msgEl = document.getElementById("msg");
  const setMsg = (t) => { if (msgEl) msgEl.textContent = t || ""; console.log("[UI]", t); };

  // Same-origin backend in production
  const API_BASE = location.origin;

  const PATH_CREATE = "/create_order";
  const PATH_VERIFY = "/verify-payment";
  const PATH_REGISTER = "/registration";

  async function readJsonSafe(resp) {
    const ct = resp.headers.get("content-type") || "";
    const text = await resp.text();
    if (!ct.includes("application/json")) throw new Error(`Expected JSON, got: ${text.slice(0,200)}`);
    try { return JSON.parse(text); } catch { throw new Error(`Bad JSON: ${text.slice(0,200)}`); }
  }

  payBtn.addEventListener("click", startPayment);

  async function startPayment () {
    try {
      const name = form.elements['name'].value.trim();
      const contact = form.elements['contact'].value.trim();
      const aadhaarRaw = form.elements['aadhaar'] ? form.elements['aadhaar'].value.replace(/\s+/g, '') : "";
      const duration = form.elements['duration'].value.trim();
      const academyJoin = form.elements['academy_join'].value.trim();

      const kitSize = form.elements['kit_size'].value.trim().toUpperCase();
      const shoeSize = form.elements['shoe_size'].value.trim();

      if (!name || !contact || !aadhaarRaw || !duration || !academyJoin || !kitSize || !shoeSize) { alert("Please fill in all required fields before proceeding."); return; }
      if (!/^(XS|S|M|XL|XXL)$/.test(kitSize)) { alert("Please select a valid Kit Size (XS, S, M, XL, XXL)."); return; }
      if (!/^\d+$/.test(shoeSize)) { alert("Shoe size must be an integer."); return; }
      if (!/^\d{12}$/.test(aadhaarRaw)) { alert("Please enter a valid 12-digit Aadhaar number."); return; }
      if (!/^\d{10}$/.test(contact)) { alert("Please enter a valid 10-digit mobile number."); return; }

      const formData = new FormData(form);
      const data = {}; formData.forEach((v, k) => data[k] = v);
      data.aadhaar = aadhaarRaw;
      data.kit_size = kitSize;
      data.shoe_size = shoeSize;

      // Create order (server enforces fixed 19900 paise)
      setMsg("Creating order…");
      const orderRes = await fetch(`${API_BASE}${PATH_CREATE}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      });
      if (!orderRes.ok) { const t = await orderRes.text(); throw new Error(`Create order ${orderRes.status}: ${t.slice(0,200)}`); }
      const order = await readJsonSafe(orderRes);

      setMsg("Opening payment popup…");
      const options = {
        key: order.key || order.key_id,
        amount: order.amount,                 // 19900 paise
        currency: order.currency || "INR",
        name: "KVS Kabaddi Academy",
        description: "Admission Fee",
        order_id: order.id || order.order_id,
        prefill: { name: data.name, contact: data.contact },
        theme: { color: "#FACC15" },
        handler: async function (response) {
          try {
            setMsg("Verifying payment…");
            const verifyRes = await fetch(`${API_BASE}${PATH_VERIFY}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature
              })
            });
            if (!verifyRes.ok) { const t = await verifyRes.text(); throw new Error(`Verify ${verifyRes.status}: ${t.slice(0,200)}`); }
            const verify = await readJsonSafe(verifyRes);

            if (!(verify && (verify.ok === true || verify.status?.includes("verified")))) {
              alert("❌ Payment verification failed on server.");
              setMsg("Verification failed."); window.location.href = "/payment_failed"; return;
            }

            setMsg("Saving registration…");
            const saveRes = await fetch(`${API_BASE}${PATH_REGISTER}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ...data, payment_id: response.razorpay_payment_id })
            });
            if (!saveRes.ok) { const t = await saveRes.text(); throw new Error(`Registration save ${saveRes.status}: ${t.slice(0,200)}`); }
            const saveJson = await readJsonSafe(saveRes);

            if (saveJson && saveJson.success) {
              window.location.href = "/payment_success_page"; // success page
            } else {
              alert("Payment verified, but saving registration failed.");
              setMsg("Payment verified, but DB save failed.");
              window.location.href = "/payment_failed";
            }
          } catch (e) {
            console.error("[handler error]", e);
            alert("Verification/save error: " + e.message);
            window.location.href = "/payment_failed";
          }
        },
        modal: { ondismiss: function(){ setMsg("Payment popup closed. No charge made."); } }
      };

      const rzp = new Razorpay(options);
      rzp.on("payment.failed", function (res) {
        alert("❌ Payment failed: " + (res.error?.description || "Unknown error"));
        window.location.href = "/payment_failed";
      });

      rzp.open();

    } catch (err) {
      console.error("[startPayment error]", err);
      setMsg("Error: " + err.message);
      alert("Error: " + err.message);
    }
  }

  // Aadhaar pretty spacing
  const aadhaarInput = document.querySelector("input[name='aadhaar']");
  if (aadhaarInput) {
    aadhaarInput.addEventListener("input", function(e) {
      let value = e.target.value.replace(/\s+/g, "").replace(/[^0-9]/g, "");
      if (value.length > 12) value = value.slice(0, 12);
      e.target.value = value.replace(/(\d{4})(?=\d)/g, "$1 ").trim();
    });
  }
});
</script>

{% endblock %}
