{% extends "base.html" %}
{% block title %}Pay with Razorpay - KVS Kabaddi Academy{% endblock %}

{% block content %}
<div class="container" style="max-width: 560px; margin: 40px auto;">
  <h2>Pay with Razorpay</h2>
  <p>Enter amount and click Pay.</p>

  <div style="margin: 16px 0;">
    <label for="amount">Amount (₹)</label>
    <input id="amount" type="number" min="1" value="499"
           style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;">
  </div>

  <button id="payBtn"
          style="padding:10px 16px;border:0;background:#0f9d58;color:#fff;border-radius:6px;cursor:pointer;">
    Pay Now
  </button>

  <div id="msg" style="margin-top:12px;color:#555;"></div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
(function () {
  const payBtn = document.getElementById("payBtn");
  const msgEl = document.getElementById("msg");
  const amountEl = document.getElementById("amount");

  function setMsg(t) { msgEl.textContent = t || ""; }

  async function createOrder(rupees) {
    const res = await fetch("/create-order", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ amount: rupees })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Order creation failed");
    return data; // { order_id, amount, currency, key }
  }

  async function verifyPayment(resp) {
    const res = await fetch("/verify-payment", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        razorpay_payment_id: resp.razorpay_payment_id,
        razorpay_order_id: resp.razorpay_order_id,
        razorpay_signature: resp.razorpay_signature
      })
    });
    return res.json(); // { ok: true/false, error? }
  }

  async function startPayment() {
    const rupees = parseInt(amountEl.value || "0", 10);
    if (!rupees || rupees < 1) { setMsg("Enter a valid amount (₹)."); return; }

    try {
      setMsg("Creating order…");
      const order = await createOrder(rupees);
      setMsg("");

      const options = {
        key: order.key,                // ✅ LIVE key from backend
        amount: order.amount,          // paise
        currency: order.currency || "INR",
        name: "KVS Kabaddi Academy",
        description: "Online Payment",
        order_id: order.order_id,
        theme: { color: "#0f9d58" },

        handler: async function (response) {
          const verify = await verifyPayment(response);
          if (verify.ok) {
            alert("✅ Payment Successful! Payment ID: " + response.razorpay_payment_id);
            window.location.href = "/payment-success";
          } else {
            alert("❌ Payment verification failed.");
            window.location.href = "/payment-failed";
          }
        },

        modal: { ondismiss: function(){ setMsg("Payment popup closed. No charge made."); } }
      };

      const rzp = new Razorpay(options);
      rzp.on("payment.failed", function (res) {
        alert("❌ Payment failed: " + (res.error && res.error.description ? res.error.description : "Unknown error"));
        window.location.href = "/payment-failed";
      });

      rzp.open();
    } catch (e) {
      setMsg("Error: " + e.message);
      console.error(e);
    }
  }

  payBtn.addEventListener("click", startPayment);
})();
</script>
{% endblock %}
