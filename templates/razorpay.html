{% extends "base.html" %}
{% block title %}Pay with Razorpay - KVS Kabaddi Academy{% endblock %}
{% block content %}
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

<div class="container" style="max-width: 560px; margin: 40px auto;">
  <h2>Pay with Razorpay</h2>
  <p style="margin-top:8px;">Admission Fee (fixed): <strong>₹199</strong></p>

  <!-- No editable amount field; amount is fixed -->
  <button id="payBtn"
          style="padding:10px 16px;border:0;background:#0f9d58;color:#fff;border-radius:6px;cursor:pointer;">
    Pay ₹199 Now
  </button>

  <div id="msg" style="margin-top:12px;color:#555;"></div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
(function () {
  const payBtn = document.getElementById("payBtn");
  const msgEl = document.getElementById("msg");
  const setMsg = (t) => { msgEl.textContent = t || ""; };

  // Same-origin backend in production
  const API_BASE = location.origin;
  const PATH_CREATE = "/create_order";      // server enforces 19900 paise
  const PATH_VERIFY = "/verify-payment";

  async function readJsonSafe(res) {
    const ct = res.headers.get("content-type") || "";
    const text = await res.text();
    if (!ct.includes("application/json")) throw new Error(`Expected JSON, got: ${text.slice(0,200)}`);
    try { return JSON.parse(text); } catch { throw new Error(`Bad JSON: ${text.slice(0,200)}`); }
  }

  // Do NOT send amount; server locks to 19900 paise
  async function createOrderFixed() {
    const res = await fetch(`${API_BASE}${PATH_CREATE}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({})   // no amount; backend uses fixed 199
    });
    if (!res.ok) { const t = await res.text(); throw new Error(`Create order ${res.status}: ${t.slice(0,200)}`); }
    return readJsonSafe(res); // { id, amount, currency, key }
  }

  async function verifyPayment(resp) {
    const res = await fetch(`${API_BASE}${PATH_VERIFY}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        razorpay_payment_id: resp.razorpay_payment_id,
        razorpay_order_id:    resp.razorpay_order_id,
        razorpay_signature:   resp.razorpay_signature
      })
    });
    if (!res.ok) { const t = await res.text(); throw new Error(`Verify ${res.status}: ${t.slice(0,200)}`); }
    return readJsonSafe(res); // { ok: true }
  }

  async function startPayment() {
    try {
      setMsg("Creating order…");
      const order = await createOrderFixed();
      setMsg("");

      const options = {
        key:       order.key || order.key_id,
        amount:    order.amount,                 // 19900 paise
        currency:  order.currency || "INR",
        name:      "KVS Kabaddi Academy",
        description: "Admission Fee (₹199)",
        order_id:  order.id || order.order_id,
        theme: { color: "#0f9d58" },
        handler: async function (response) {
          try {
            const verify = await verifyPayment(response);
            if (verify && (verify.ok === true || verify.status === "verified")) {
              window.location.href = "/payment_success_page";  // underscore route in Flask
            } else {
              window.location.href = "/payment_failed";
            }
          } catch (e) {
            window.location.href = "/payment_failed";
          }
        },
        modal: { ondismiss: function(){ setMsg("Payment popup closed. No charge made."); } }
      };

      const rzp = new Razorpay(options);
      rzp.on("payment.failed", function (res) {
        window.location.href = "/payment_failed";
      });

      rzp.open();
    } catch (e) {
      setMsg("Error: " + e.message);
      console.error(e);
    }
  }

  payBtn.addEventListener("click", startPayment);
})();
</script>
{% endblock %}
